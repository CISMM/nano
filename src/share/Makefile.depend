MAKEFILE_DEPEND := $(OBJECT_DIR)/.depend

ifeq ($(findstring depend,$(MAKECMDGOALS)),depend)
   DUMMY := $(shell mv -f $(MAKEFILE_DEPEND) $(MAKEFILE_DEPEND)-old)
else
   -include $(MAKEFILE_DEPEND)
endif

##############################################################################
#
# Expand the uses libs stuff
#

DEPEND_EXISTS := $(shell test -r $(MAKEFILE_DEPEND) && echo "true")
ifneq ($(DEPEND_EXISTS),true)
   ifdef USES_LIBS
      ALT_LIBS := $(foreach lib,$(USES_LIBS),$(findstring $(lib),$(filter-out -L/%,$(MY_ALT_LIB_DIR))))
      SEARCH_LIBS := $(filter-out $(ALT_LIBS),$(USES_LIBS))
      USES_LIBS_TMP := $(foreach lib,$(SEARCH_LIBS),$(shell $(SEARCH_PROG) $(HW_OS)$(OBJECT_DIR_SUFFIX) $(lib) $(SEARCH_PATH)))
      USES_LIBS_INC := $(filter-out -L%,$(USES_LIBS_TMP))
      USES_LIBS_LD  := $(filter-out -I%,$(USES_LIBS_TMP))
      USES_LIBS_LIB := $(addprefix -l,$(USES_LIBS))
   endif

   ifdef NAUGHTY
      USES_LIBS_INC += -I$(TOP_LEVEL_SRC_DIR)/app/nano
   endif
endif

##############################################################################
#
# Compile list of files for dependencies
#

SRC_LIST := $(APP_SRC) $(LIBRARY_SRC)

ifdef APP_EXEC
   APP_LIST := "$(APP_EXEC): $(join $(patsubst -L%,%,$(USES_LIBS_LD)),$(addprefix /lib,$(addsuffix .a,$(SEARCH_LIBS))))"
endif

DEPEND_BUILD_RULE := ( \
   $(CC) -M $(CFLAGS) $(DEFINES) $(filter-out -L%,$(MY_ALT_LIB_DIR)) $(USES_LIBS_INC) $(INCLUDE_FLAGS) $(SRC_LIST) | perl -pe "s|(.*\\.o\\w*:)|$(OBJECT_DIR)/\\1|g;" ; \
   echo $(APP_LIST) ; \
   echo DEP_LIBS_INC := $(filter-out -L%,$(MY_ALT_LIB_DIR)) $(USES_LIBS_INC) ; \
   echo DEP_LIBS_LD := $(filter-out -I%,$(MY_ALT_LIB_DIR)) $(USES_LIBS_LD) ; \
   echo DEP_LIBS_LIB := $(USES_LIBS_LIB) ; \
   echo MY_ALT_LIB_DIR := $(MY_ALT_LIB_DIR) ; \
   echo ALT_LIBS := $(ALT_LIBS) ; \
   echo SEARCH_LIBS := $(SEARCH_LIBS) \
                     )

.PHONY: depend
depend: $(OBJECT_DIR) $(MAKEFILE_DEPEND)

$(MAKEFILE_DEPEND):
	@echo ---------------------------------------------------------------- 
	@echo -- Making dependency file.  If you add files to the makefile,
	@echo -- or add/remove includes from a .h or .C file, then you should
	@echo -- remake the dependency file by typing \"$(MAKE) depend\"
	@echo ----------------------------------------------------------------
	$(DEPEND_BUILD_RULE) > $(MAKEFILE_DEPEND)
